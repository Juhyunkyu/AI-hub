# 채팅 읽지 않은 메시지 카운트 수동 테스트 가이드

## 🎯 테스트 목적
채팅방 안에 있을 때는 읽지 않은 메시지 카운트가 증가하지 않아야 하고, 채팅방 밖에 있을 때만 증가해야 함을 검증합니다.

---

## 📋 사전 준비

### 1. 서버 실행
```bash
npm run dev
```
서버가 http://localhost:3000 에서 실행되어야 합니다.

### 2. 테스트용 사용자 계정
- **주현규 계정**: test-user1@example.com / TestPassword123!
- **박할매 계정**: test-user2@example.com / TestPassword123!

(계정이 없으면 회원가입 후 진행)

### 3. 테스트용 채팅방
- 두 사용자가 참여하는 채팅방이 있어야 합니다.
- 채팅방 이름: "테스트 채팅방" (또는 임의의 이름)

---

## 🧪 테스트 시나리오 1: 채팅방 안에서 메시지 수신

### 목표
채팅방 안에 있을 때는 읽지 않은 메시지 카운트가 **증가하지 않아야** 합니다.

### 단계
1. **브라우저 2개 준비**
   - 브라우저 1: Chrome (일반 창)
   - 브라우저 2: Chrome (시크릿 모드) 또는 Firefox

2. **두 사용자 로그인**
   - 브라우저 1 → 주현규 로그인
   - 브라우저 2 → 박할매 로그인

3. **두 사용자 모두 같은 채팅방 진입**
   - 브라우저 1: `/chat` → "테스트 채팅방" 클릭
   - 브라우저 2: `/chat` → "테스트 채팅방" 클릭

4. **주현규가 메시지 전송 (브라우저 1)**
   ```
   메시지: "안녕하세요!"
   Enter 키 전송
   ```

5. **박할매 화면 확인 (브라우저 2)**
   - ✅ 메시지가 실시간으로 보여야 함
   - ✅ 채팅방 리스트의 읽지 않은 메시지 카운트: **0** (빨간 동그라미 없음)
   - ✅ 헤더 네비게이션바의 채팅 아이콘: 빨간 점 **없음**

### 예상 결과
- 채팅방 안에 있으므로 카운트가 증가하지 않음
- 자동으로 읽음 처리됨

---

## 🧪 테스트 시나리오 2: 채팅방 밖에서 메시지 수신

### 목표
채팅방 밖에 있을 때 메시지를 받으면 읽지 않은 메시지 카운트가 **증가해야** 합니다.

### 단계
1. **두 사용자 로그인 (이전과 동일)**

2. **주현규만 채팅방 진입**
   - 브라우저 1: `/chat` → "테스트 채팅방" 클릭
   - 브라우저 2: `/chat` (채팅 리스트 화면에 머무름)

3. **주현규가 메시지 전송 (브라우저 1)**
   ```
   메시지: "박할매님 계세요?"
   Enter 키 전송
   ```

4. **박할매 화면 확인 (브라우저 2)**
   - ✅ 채팅방 리스트의 "테스트 채팅방" 옆에 빨간 동그라미 **1** 표시
   - ✅ 헤더 네비게이션바의 채팅 아이콘에 빨간 점 표시

### 예상 결과
- 채팅방 밖에 있으므로 카운트가 1 증가
- 헤더 네비게이션바에도 알림 표시

---

## 🧪 테스트 시나리오 3: 채팅방 진입 시 카운트 초기화

### 목표
읽지 않은 메시지가 있는 채팅방에 진입하면 카운트가 **0으로 초기화**되어야 합니다.

### 단계
1. **시나리오 2의 상태 유지** (박할매에게 읽지 않은 메시지 1개)

2. **박할매가 채팅방 진입 (브라우저 2)**
   - 채팅 리스트에서 "테스트 채팅방" 클릭

3. **박할매 화면 확인**
   - ✅ 메시지가 보여야 함
   - ✅ 읽음 처리됨

4. **박할매가 다시 채팅 리스트로 이동**
   - 뒤로가기 버튼 클릭 (또는 "채팅방" 클릭)

5. **채팅 리스트 확인**
   - ✅ "테스트 채팅방" 옆의 빨간 동그라미 **사라짐** (카운트 0)
   - ✅ 헤더 네비게이션바의 빨간 점도 **사라짐**

### 예상 결과
- 채팅방 진입 시 자동으로 읽음 처리되어 카운트가 0으로 초기화됨

---

## 🧪 테스트 시나리오 4: 모바일 반응형

### 목표
모바일 화면에서도 동일하게 작동해야 합니다.

### 단계
1. **브라우저 개발자 도구 (F12)**
   - 모바일 뷰로 전환 (Ctrl+Shift+M)
   - 디바이스: iPhone 12 또는 Galaxy S20

2. **시나리오 1~3 반복**
   - 모바일 화면에서는 채팅방과 리스트가 전환됨
   - 채팅방 안에 있을 때는 카운트 증가 안 함
   - 채팅방 밖에 있을 때는 카운트 증가

### 예상 결과
- 데스크톱과 동일한 동작

---

## 🐛 버그 발견 시 체크리스트

만약 테스트가 실패하면 다음을 확인하세요:

### ❌ 채팅방 안에서도 카운트가 증가하는 경우
- [ ] 브라우저 콘솔에 에러가 있는지 확인
- [ ] `use-notifications.ts`의 실시간 구독이 정상 작동하는지 확인
- [ ] `chat-layout.tsx`의 `markAsRead` 호출이 정상인지 확인
- [ ] `/api/chat/read` API 호출이 성공했는지 확인 (Network 탭)

### ❌ 채팅방 밖에서도 카운트가 증가하지 않는 경우
- [ ] Supabase Realtime 연결 상태 확인
- [ ] `/api/chat/unread` API가 정상 응답하는지 확인
- [ ] `message_reads` 테이블에 데이터가 기록되는지 확인

### ❌ 카운트가 초기화되지 않는 경우
- [ ] `markAsRead` 함수 호출 확인
- [ ] API 응답 확인 (200 OK)
- [ ] TanStack Query 캐시 갱신 확인

---

## 📊 테스트 결과 기록

| 시나리오 | 예상 결과 | 실제 결과 | 통과 여부 |
|---------|----------|----------|----------|
| 채팅방 안에서 수신 | 카운트 0 | ? | ⬜ |
| 채팅방 밖에서 수신 | 카운트 1+ | ? | ⬜ |
| 채팅방 진입 시 | 카운트 0으로 초기화 | ? | ⬜ |
| 모바일 반응형 | 데스크톱과 동일 | ? | ⬜ |

---

## 🔧 Playwright MCP를 통한 자동화 테스트

Playwright MCP를 사용하면 Claude가 직접 브라우저를 제어할 수 있습니다:

```typescript
// Playwright MCP 명령어 예시
await mcp__playwright__browser_navigate({ url: "http://localhost:3000/login" });
await mcp__playwright__browser_type({ element: "이메일 입력", ref: "input[type='email']", text: "test-user1@example.com" });
await mcp__playwright__browser_click({ element: "로그인 버튼", ref: "button[type='submit']" });
```

Claude에게 요청하면 자동으로 테스트를 실행할 수 있습니다!

---

## ✅ 수정 사항 요약

### 변경된 파일
1. **`/src/hooks/use-notifications.ts`**
   - 실시간 메시지 수신 시 카운트 갱신 지연 (300ms → 500ms)
   - 읽음 처리 완료 후 갱신되도록 타이밍 조정

2. **`/src/components/chat/chat-layout.tsx`**
   - 임시 메시지(temp-) 제외하고 실제 메시지만 읽음 처리
   - 주석 개선으로 의도 명확화

### 기대 효과
- ✅ 채팅방 안에서는 카운트 증가하지 않음
- ✅ 채팅방 밖에서만 카운트 증가
- ✅ 읽음 처리 타이밍 레이스 조건 해결
