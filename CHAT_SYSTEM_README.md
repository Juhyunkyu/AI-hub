# AI 지식 허브 - 채팅 시스템

## 🚀 주요 기능

### 1. 인스타그램 스타일 채팅 시스템
- **1:1 채팅**: 사용자 간 직접 메시지 교환
- **그룹 채팅**: 여러 사용자가 참여하는 채팅방
- **실시간 메시징**: Supabase Realtime을 활용한 실시간 메시지 전송
- **읽음 표시**: 메시지 읽음/안읽음 상태 표시

### 2. 사용자 친화적 인터페이스
- **네비게이션 바 채팅 아이콘**: 읽지 않은 메시지 수 표시
- **채팅방 목록**: 최근 메시지와 읽지 않은 메시지 수 표시
- **타이핑 인디케이터**: 상대방이 입력 중일 때 표시
- **모바일 반응형**: 모든 디바이스에서 최적화된 UI

### 3. DM 보내기 기능
- **사용자 프로필에서 DM**: 게시글이나 댓글의 사용자명 클릭 → "DM 보내기"
- **기존 채팅방 확인**: 이미 채팅 중인 사용자는 기존 채팅방으로 이동
- **새 채팅방 생성**: 처음 대화하는 사용자와 새 채팅방 자동 생성

### 4. 채팅방 초대 시스템
- **사용자 검색**: 전체 사용자, 팔로워, 팔로잉 목록에서 검색
- **그룹 채팅 초대**: 관리자가 새로운 사용자를 그룹에 초대
- **실시간 참여자 목록**: 현재 채팅방 참여자 확인

### 5. 파일 공유 기능
- **이미지 업로드**: 이미지 파일 전송 및 미리보기
- **파일 업로드**: PDF, 문서, 텍스트 파일 등 지원
- **파일 크기 제한**: 10MB 이하 파일만 업로드 가능
- **안전한 저장**: Supabase Storage를 활용한 안전한 파일 저장

## 🛠 기술 스택

### Frontend
- **Next.js 15**: App Router, Server Components
- **TypeScript**: 타입 안전성
- **TailwindCSS**: 스타일링
- **shadcn/ui**: UI 컴포넌트
- **Zustand**: 상태 관리

### Backend
- **Supabase**: 데이터베이스, 인증, 실시간, 스토리지
- **PostgreSQL**: 메인 데이터베이스
- **Row Level Security**: 데이터 보안
- **Supabase Realtime**: 실시간 메시징

## 📊 데이터베이스 구조

### 주요 테이블
1. **chat_rooms**: 채팅방 정보
2. **chat_room_participants**: 채팅방 참여자
3. **chat_messages**: 메시지 내용
4. **chat_message_reads**: 메시지 읽음 상태
5. **chat_typing_status**: 타이핑 상태

### RLS 정책
- 참여자만 채팅방과 메시지에 접근 가능
- 관리자만 그룹 채팅에 사용자 초대 가능
- 파일은 채팅방 참여자만 업로드/다운로드 가능

## 🔧 사용 방법

### 1. 채팅 시작하기
```typescript
// 사용자 프로필에서 DM 보내기
<UserAvatar 
  userId="user-id"
  username="username"
  showActions={true}
/>
```

### 2. 채팅방 생성
```typescript
// 새 채팅방 생성 모달
<CreateChatModal
  open={showModal}
  onOpenChange={setShowModal}
  mode="create"
/>
```

### 3. 사용자 초대
```typescript
// 그룹 채팅에 사용자 초대
<CreateChatModal
  open={showInviteModal}
  onOpenChange={setShowInviteModal}
  roomId={roomId}
  mode="invite"
/>
```

## 🚀 API 엔드포인트

### 채팅방 관리
- `GET /api/chat/rooms` - 채팅방 목록 조회
- `POST /api/chat/rooms` - 새 채팅방 생성
- `POST /api/chat/rooms/[roomId]/invite` - 사용자 초대

### 메시지 관리
- `GET /api/chat/messages` - 메시지 목록 조회
- `POST /api/chat/messages` - 새 메시지 전송

### 사용자 검색
- `GET /api/chat/users` - 채팅 초대용 사용자 검색

### 파일 업로드
- `POST /api/chat/upload` - 파일 업로드

### 타이핑 상태
- `POST /api/chat/typing` - 타이핑 상태 업데이트

## 🔒 보안 기능

### 1. 인증 및 권한
- 로그인한 사용자만 채팅 기능 사용 가능
- 채팅방 참여자만 메시지 조회/전송 가능
- 관리자만 그룹 채팅 관리 가능

### 2. 파일 업로드 보안
- 허용된 파일 타입만 업로드 가능
- 파일 크기 제한 (10MB)
- 채팅방 참여자만 파일 접근 가능

### 3. 데이터 보호
- Row Level Security로 데이터 접근 제어
- 실시간 구독도 RLS 정책 적용
- 사용자별 데이터 격리

## 🎯 주요 개선사항

### 기존 문제점 해결
1. **중복 메시지 시스템 정리**: 기존 `messages` 테이블과 새 채팅 시스템 분리
2. **실시간 기능 개선**: Supabase Realtime을 활용한 안정적인 실시간 메시징
3. **사용자 경험 향상**: 인스타그램 스타일의 직관적인 UI/UX
4. **성능 최적화**: 효율적인 데이터 로딩과 캐싱

### 새로운 기능 추가
1. **파일 공유**: 이미지, 문서 등 다양한 파일 전송
2. **그룹 채팅**: 여러 사용자가 참여하는 채팅방
3. **사용자 초대**: 팔로워/팔로잉 기반 사용자 검색 및 초대
4. **읽음 표시**: 메시지 읽음 상태 실시간 업데이트

## 📱 사용자 플로우

### 1. DM 보내기
1. 게시글/댓글에서 사용자명 클릭
2. "DM 보내기" 선택
3. 기존 채팅방이 있으면 해당 방으로 이동
4. 없으면 새 채팅방 자동 생성

### 2. 그룹 채팅 만들기
1. 채팅 페이지에서 "+" 버튼 클릭
2. "그룹 채팅" 선택
3. 채팅방 이름 입력
4. 참여자 검색 및 선택
5. 그룹 채팅방 생성

### 3. 사용자 초대하기
1. 그룹 채팅방에서 "초대" 버튼 클릭
2. 전체/팔로워/팔로잉에서 사용자 검색
3. 초대할 사용자 선택
4. 초대 완료

## 🔄 실시간 기능

### 1. 메시지 실시간 전송
- 새 메시지 즉시 표시
- 타이핑 상태 실시간 업데이트
- 읽음 상태 실시간 동기화

### 2. 채팅방 목록 업데이트
- 새 메시지 도착 시 채팅방 목록 자동 정렬
- 읽지 않은 메시지 수 실시간 업데이트
- 네비게이션 바 알림 배지 실시간 업데이트

이제 완전히 기능하는 인스타그램 스타일의 채팅 시스템이 구현되었습니다! 🎉