# ì´ë¯¸ì§€ ë¼ì´íŠ¸ë°•ìŠ¤ Share/Delete ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ìš”ì•½

**ì‘ì„±ì¼**: 2025-10-16
**ìƒíƒœ**: ì¼ë¶€ ì™„ë£Œ, ì¶”ê°€ ì‘ì—… í•„ìš”

## ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­

ì‚¬ìš©ìê°€ ë³´ê³ í•œ ë¬¸ì œì :
1. **ì‚­ì œ ë²„íŠ¼**: "ë©”ì‹œì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤" ì˜¤ë¥˜ ë°œìƒ
2. **ì¹œêµ¬ ëª©ë¡ UI**:
   - ì†Œê°œê¸€(bio)ì´ ê¸¸ë©´ ì˜ë¦¼
   - ì¹œêµ¬ê°€ ë§ì•„ì§€ë©´(100ëª…+) ì°¾ê¸° ì–´ë ¤ì›€
   - **ìš”ì²­**: ì•„ë°”íƒ€ + ë‹‰ë„¤ì„ë§Œ í‘œì‹œ, ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
3. **ê³µìœ  ê¸°ëŠ¥**: ì´ì „ ì„¸ì…˜ì—ì„œ ìˆ˜ì •í–ˆìœ¼ë‚˜ ì¬í…ŒìŠ¤íŠ¸ í•„ìš”

## ì™„ë£Œëœ ì‘ì—…

### 1. Share ê¸°ëŠ¥ ìˆ˜ì •
**íŒŒì¼**: `src/components/shared/image-lightbox.tsx`

**ë¬¸ì œ 1 - 400 Bad Request (Zod ê²€ì¦ ì‹¤íŒ¨)**
- **ìœ„ì¹˜**: Lines 252-260
- **ì›ì¸**: CreateChatRoomSchemaê°€ ëª¨ë“  í•„ë“œ ìš”êµ¬ (name, description, avatar_url, is_private, max_participants)
- **í•´ê²°**:
```typescript
body: JSON.stringify({
  type: 'direct',
  participant_ids: [friendId],
  name: null,
  description: null,
  avatar_url: null,
  is_private: false,
  max_participants: null,
}),
```

**ë¬¸ì œ 2 - 403 Forbidden (ì˜ëª»ëœ room ID ì¶”ì¶œ)**
- **ìœ„ì¹˜**: Line 269
- **ì›ì¸**: APIê°€ `{ room: { id: ... } }` êµ¬ì¡°ë¡œ ì‘ë‹µí•˜ëŠ”ë° `roomData.room_id` ì‚¬ìš©
- **í•´ê²°**:
```typescript
const roomId = roomData.room?.id || roomData.room_id || roomData.id;
```

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:
- âœ… POST /api/chat/rooms 200
- âœ… POST /api/chat/messages 200
- âœ… "1ëª…ì—ê²Œ ì´ë¯¸ì§€ë¥¼ ê³µìœ í–ˆìŠµë‹ˆë‹¤" ì•Œë¦¼ í‘œì‹œ
- âœ… ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ

### 2. ì¹œêµ¬ ì„ íƒ UI ê°œì„ 
**íŒŒì¼**: `src/components/shared/friend-selection-dialog.tsx`

**ë³€ê²½ì‚¬í•­**:
- Line 5: Search ì•„ì´ì½˜ import ì¶”ê°€
- Line 39: `searchQuery` state ì¶”ê°€
- Lines 54-61: `filteredFriends` í•„í„°ë§ ë¡œì§ êµ¬í˜„
- Lines 110-120: ê²€ìƒ‰ ì…ë ¥ UI ì¶”ê°€
- Lines 135-138: ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ìƒíƒœ ì¶”ê°€
- Lines 174-176: Bio í‘œì‹œ ì œê±° (usernameë§Œ í‘œì‹œ)

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:
- âœ… Bio ì œê±°ë¨ (ì•„ë°”íƒ€ + ë‹‰ë„¤ì„ë§Œ)
- âœ… ê²€ìƒ‰ ì…ë ¥ì°½ ì •ìƒ ì‘ë™
- âœ… ì‹¤ì‹œê°„ í•„í„°ë§ ì‘ë™

### 3. Delete ê¸°ëŠ¥ Props ìˆ˜ì •
**íŒŒì¼ 1**: `src/components/shared/image-lightbox.tsx`
- Lines 624-645: ClickableImageProps ì¸í„°í˜ì´ìŠ¤ì— delete ê´€ë ¨ props ì¶”ê°€
  - messageId, senderId, currentUserId, roomId
  - senderName, senderAvatar, sentAt
- Lines 647-666: ClickableImage í•¨ìˆ˜ signature ì—…ë°ì´íŠ¸
- Lines 703-717: ImageLightboxì— props ì „ë‹¬

**íŒŒì¼ 2**: `src/components/chat/virtualized/MessageRenderer.tsx`
- Lines 92-104: MessageContentì— currentUserId prop ì¶”ê°€
- Lines 141-149: ClickableImageì— delete props ì „ë‹¬
- Lines 577-583: MessageContent í˜¸ì¶œ ì‹œ currentUserId ì „ë‹¬

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:
- âœ… ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
- âœ… DELETE /api/chat/messages/[id] 200 ì‘ë‹µ
- âœ… ë¼ì´íŠ¸ë°•ìŠ¤ ìë™ ë‹«í˜

## âš ï¸ ì‚¬ìš©ì í”¼ë“œë°±: "ì˜ë„í•œëŒ€ë¡œ ë˜ì§€ ì•ŠìŒ"

ì‚¬ìš©ìê°€ ê¸°ëŒ€í•œ ë™ì‘ê³¼ ì‹¤ì œ ë™ì‘ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸ í•„ìš”:

### í™•ì¸ í•„ìš” ì‚¬í•­

1. **ì‚­ì œ í›„ ë©”ì‹œì§€ ì‚¬ë¼ì§ í™•ì¸**
   - í˜„ì¬: DELETE APIëŠ” 200 ì‘ë‹µ
   - í™•ì¸ í•„ìš”: ì±„íŒ… ëª©ë¡ì—ì„œ ì‹¤ì œë¡œ ë©”ì‹œì§€ê°€ ì‚¬ë¼ì¡ŒëŠ”ì§€?
   - ê°€ëŠ¥í•œ ë¬¸ì œ:
     - Realtime ì—…ë°ì´íŠ¸ ëˆ„ë½?
     - ìºì‹œ ë¬´íš¨í™” ì•ˆ ë¨?
     - Soft delete vs Hard delete ë¡œì§?

2. **ì¹œêµ¬ ê²€ìƒ‰ ê¸°ëŠ¥**
   - í˜„ì¬: ê²€ìƒ‰ ì…ë ¥ì°½ ì¶”ê°€ë¨
   - í™•ì¸ í•„ìš”: ì‹¤ì œë¡œ ê²€ìƒ‰ì´ ì˜ ë˜ëŠ”ì§€? (í•œê¸€ ì…ë ¥ í…ŒìŠ¤íŠ¸)

3. **ê³µìœ  í›„ ë©”ì‹œì§€ í™•ì¸**
   - í˜„ì¬: POST ìš”ì²­ ì„±ê³µ
   - í™•ì¸ í•„ìš”:
     - ìƒëŒ€ë°© ì±„íŒ…ë°©ì— ì´ë¯¸ì§€ê°€ ì œëŒ€ë¡œ ì „ì†¡ë˜ì—ˆëŠ”ì§€?
     - ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ê°€ ì •ìƒì¸ì§€?

## ë‹¤ìŒ ì„¸ì…˜ ì‘ì—… ê³„íš

### 1ë‹¨ê³„: í˜„ì¬ ë¬¸ì œ í™•ì¸
```bash
# ì„œë²„ ì‹¤í–‰
npm run dev

# ë¸Œë¼ìš°ì €ì—ì„œ ìˆ˜ë™ í…ŒìŠ¤íŠ¸
# 1. ì±„íŒ…ë°© ì ‘ì†
# 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ
# 3. Share ë²„íŠ¼ â†’ ì¹œêµ¬ ì„ íƒ â†’ ê³µìœ  ì‹¤í–‰
#    - ìƒëŒ€ë°© ì±„íŒ…ë°©ì— ì´ë¯¸ì§€ ì „ì†¡ í™•ì¸
# 4. Delete ë²„íŠ¼ â†’ í™•ì¸
#    - ë©”ì‹œì§€ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§€ëŠ”ì§€ í™•ì¸
# 5. ì¹œêµ¬ ê²€ìƒ‰ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```

### 2ë‹¨ê³„: ì¶”ê°€ ìˆ˜ì • ê°€ëŠ¥ì„±

#### A. ì‚­ì œ í›„ UI ì—…ë°ì´íŠ¸ ë¬¸ì œ
**ê°€ëŠ¥í•œ ì›ì¸**:
- TanStack Query ìºì‹œ ë¬´íš¨í™” ëˆ„ë½
- Realtime êµ¬ë…ì—ì„œ DELETE ì´ë²¤íŠ¸ ì²˜ë¦¬ ëˆ„ë½

**í™•ì¸ ìœ„ì¹˜**:
- `src/components/shared/image-lightbox.tsx`: handleDelete í•¨ìˆ˜
- `src/hooks/use-chat-hook.ts`: Realtime êµ¬ë… ë¡œì§

**ìˆ˜ì • ë°©í–¥**:
```typescript
// handleDelete ì„±ê³µ í›„
queryClient.invalidateQueries(['chat-messages', roomId]);
// ë˜ëŠ” optimistic updateë¡œ ë©”ì‹œì§€ ì¦‰ì‹œ ì œê±°
```

#### B. ê³µìœ  í›„ ì´ë¯¸ì§€ í‘œì‹œ ë¬¸ì œ
**í™•ì¸ ìœ„ì¹˜**:
- `/api/chat/messages` ë¼ìš°íŠ¸: ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì €ì¥
- MessageRenderer: ì´ë¯¸ì§€ ë Œë”ë§ ë¡œì§

#### C. ì¹œêµ¬ ê²€ìƒ‰ ì„±ëŠ¥ ë¬¸ì œ
**í˜„ì¬ êµ¬í˜„**: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§
**ê°œì„  ë°©í–¥**: ì¹œêµ¬ê°€ ë§ì„ ê²½ìš° ì„œë²„ ì‚¬ì´ë“œ ê²€ìƒ‰

### 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

**ì‹œë‚˜ë¦¬ì˜¤ 1: ì‚­ì œ í…ŒìŠ¤íŠ¸**
```
1. ì±„íŒ…ë°©ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
2. ì´ë¯¸ì§€ í´ë¦­ â†’ ë¼ì´íŠ¸ë°•ìŠ¤ ì—´ê¸°
3. ì‚­ì œ ë²„íŠ¼ í´ë¦­ â†’ í™•ì¸
4. ê¸°ëŒ€ ê²°ê³¼:
   - ë¼ì´íŠ¸ë°•ìŠ¤ ë‹«í˜ âœ…
   - ì±„íŒ… ëª©ë¡ì—ì„œ ë©”ì‹œì§€ ì¦‰ì‹œ ì‚¬ë¼ì§ â“
   - ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ë©”ì‹œì§€ ì—†ìŒ â“
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: ê³µìœ  í…ŒìŠ¤íŠ¸**
```
1. ì±„íŒ…ë°©ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
2. ì´ë¯¸ì§€ í´ë¦­ â†’ ë¼ì´íŠ¸ë°•ìŠ¤ ì—´ê¸°
3. ê³µìœ  ë²„íŠ¼ í´ë¦­ â†’ ì¹œêµ¬ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
4. ì¹œêµ¬ ê²€ìƒ‰ (ì˜ˆ: "ë°•" ì…ë ¥)
5. ì¹œêµ¬ ì„ íƒ â†’ ê³µìœ  ë²„íŠ¼ í´ë¦­
6. ê¸°ëŒ€ ê²°ê³¼:
   - "1ëª…ì—ê²Œ ì´ë¯¸ì§€ë¥¼ ê³µìœ í–ˆìŠµë‹ˆë‹¤" ì•Œë¦¼ âœ…
   - ìƒëŒ€ë°© ì±„íŒ…ë°©ì— ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ì†¡ë¨ â“
   - ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨ â“
```

## ê´€ë ¨ íŒŒì¼ ìœ„ì¹˜

### í•µì‹¬ íŒŒì¼
- `src/components/shared/image-lightbox.tsx` - ë¼ì´íŠ¸ë°•ìŠ¤ ë©”ì¸ ì»´í¬ë„ŒíŠ¸
- `src/components/shared/friend-selection-dialog.tsx` - ì¹œêµ¬ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
- `src/components/chat/virtualized/MessageRenderer.tsx` - ë©”ì‹œì§€ ë Œë”ë§
- `src/app/api/chat/messages/[messageId]/route.ts` - ì‚­ì œ API
- `src/app/api/chat/messages/route.ts` - ë©”ì‹œì§€ ìƒì„± API
- `src/app/api/chat/rooms/route.ts` - ì±„íŒ…ë°© ìƒì„± API

### ê´€ë ¨ ë¬¸ì„œ
- `docs/CHAT_SYSTEM.md` - ì±„íŒ… ì‹œìŠ¤í…œ ì „ì²´ ë¬¸ì„œ
- `supabase/migrations/20251016010000_add_soft_delete_to_chat_messages.sql` - Soft delete ë§ˆì´ê·¸ë ˆì´ì…˜

## ë””ë²„ê¹… íŒ

### 1. ì„œë²„ ë¡œê·¸ í™•ì¸
```bash
# DELETE ìš”ì²­ í™•ì¸
grep "DELETE /api/chat/messages"

# ì‘ë‹µ ìƒíƒœ í™•ì¸ (200 = ì„±ê³µ)
# soft delete vs hard delete ë©”ì‹œì§€ í™•ì¸
```

### 2. ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸
```javascript
// Realtime ì´ë²¤íŠ¸ í™•ì¸
// "ğŸ“¨ New realtime message received" ë¡œê·¸

// TanStack Query devtoolsì—ì„œ ìºì‹œ ìƒíƒœ í™•ì¸
```

### 3. Supabase í™•ì¸
```sql
-- ë©”ì‹œì§€ ì‹¤ì œ ì‚­ì œ ì—¬ë¶€ í™•ì¸
SELECT * FROM chat_messages WHERE id = 'message_id';

-- Soft delete í™•ì¸
SELECT deleted_for FROM chat_messages WHERE id = 'message_id';
```

## ì˜ˆìƒë˜ëŠ” ì¶”ê°€ ì‘ì—…

1. **handleDelete í•¨ìˆ˜ ê°œì„ ** (image-lightbox.tsx)
   - ì„±ê³µ ì‹œ ìºì‹œ ë¬´íš¨í™” ë˜ëŠ” optimistic update
   - ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 

2. **Realtime êµ¬ë… ë¡œì§** (use-chat-hook.ts)
   - DELETE ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¶”ê°€
   - ë©”ì‹œì§€ ëª©ë¡ì—ì„œ ì¦‰ì‹œ ì œê±°

3. **ì¹œêµ¬ ê²€ìƒ‰ ìµœì í™”**
   - ë””ë°”ìš´ì‹± ì¶”ê°€
   - ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ ê²€ì¦

## ì°¸ê³  ì‚¬í•­

- **ê°œë°œ ì„œë²„**: `npm run dev` (í¬íŠ¸ 3000)
- **í…ŒìŠ¤íŠ¸ ê³„ì •**: ì£¼í˜„ê·œ (ì´ë¯¸ ë¡œê·¸ì¸ë¨)
- **í…ŒìŠ¤íŠ¸ ì±„íŒ…ë°©**: ë°•í• ë§¤ (room_id: a009a352-0548-49af-a223-acfd497965d6)
- **Git ìƒíƒœ**:
  - Modified: docs/FEATURES.md
  - Branch: master
